<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SVG Test</title>
    <style>
        #mySvg {
            width: 100vw;
            height: 100vh;
        }

        .handler {
            cursor: pointer;
        }
    </style>
</head>
<body>
<svg id="mySvg"></svg>
<script>
    const mySvg = document.querySelector("#mySvg");

    let drawingObj = null;
    let editingObj = null;

    /**
     * 画图基类
     */
    class SgBaseItem {
        id;
        x;
        y;
        /**
         * 3种状态：
         * "": 正常
         * "moving": 移动状态（整体移动）
         * "editing": 选中状态（可进行大小调整）
         */
        state = "";
        editHandler = [];


        /**
         * 使用 ID 和位置初始化对象、
         * @param id
         * @param x
         * @param y
         */
        constructor({id, x, y}) {
            this.id = id;
            this.x = x;
            this.y = y;
        }

        /**
         * 用于响应移动事件。
         * 将本对象某某部位移动到哪个位置。
         * @param thing 部位名称
         * @param x 目标位置
         * @param y 目标位置
         */
        moveTo(thing, x, y) {
        }

        /**
         * 用于获取封装的图形元素
         */
        get obj() {
        }


        /**
         * 进入编辑模式
         */
        enableEdit() {
            this.state = "editing";
            if (editingObj) {
                editingObj.disableEdit();
            }
            editingObj = this;
        }

        /**
         * 取消编辑模式
         */
        disableEdit() {
            this.state = "";
            editingObj = null;
        }


        /**
         * 快捷初始化”把手“
         * @param count
         * @param x
         * @param y
         */
        initHandlers(count, x, y) {
            if (count > 0) {
                for (let i = 0; i < count; i++) {
                    this.editHandler.push(this.createHandler(x, y))
                }
            }
        }

        /**
         * 编辑“把手”
         * @param x
         * @param y
         * @returns {SVGCircleElement}
         */
        createHandler(x, y) {
            const handler = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            handler.setAttribute("cx", x);
            handler.setAttribute("cy", y);
            handler.setAttribute("stroke", "black");
            handler.setAttribute("r", "5");
            handler.classList.add("handler")
            return handler;
        }
    }


    /**
     * 封装的直线类。
     */
    class SgLine extends SgBaseItem {
        endX;
        endY;
        lineObj;


        /**
         * 在构造函数中创建 svg 对象。
         * @param id
         * @param x
         * @param y
         */
        constructor({id, x, y}) {
            super({id, x, y});
            this.lineObj = document.createElementNS("http://www.w3.org/2000/svg", "line");
            this.lineObj.setAttribute("id", this.id);
            this.lineObj.setAttribute("x1", this.x);
            this.lineObj.setAttribute("y1", this.y);
            this.lineObj.setAttribute("stroke", "black");
            this.lineObj.parent = this;

            // 初始化两个”把手“
            this.initHandlers(2, this.x, this.y);
            // 添加点击事件
            this.lineObj.addEventListener("click", (e) => {
                this.enableEdit();
            });
        }


        enableEdit() {
            super.enableEdit();
            const startHandler = this.editHandler[0];
            startHandler.setAttribute("cx", this.x);
            startHandler.setAttribute("cy", this.y);
            const endHandler = this.editHandler[1];
            endHandler.setAttribute("cx", this.endX);
            endHandler.setAttribute("cy", this.endY);
            this.editHandler.forEach((eh) => mySvg.appendChild(eh));
        }

        disableEdit() {
            super.disableEdit();
            this.editHandler.forEach((eh) => mySvg.removeChild(eh));
        }

        /**
         * 响应移动事件，默认移动末点。
         * @param thing
         * @param x
         * @param y
         */
        moveTo(thing, x, y) {
            if (!thing || thing === 'end') {
                this.endX = x;
                this.endY = y;
                this.lineObj.setAttribute("x2", this.endX);
                this.lineObj.setAttribute("y2", this.endY);
            }
        }

        /**
         * 返回 svg 封装的直线元素。
         * @returns {*}
         */
        get obj() {
            return this.lineObj;
        }

    }


    // 鼠标是否按下
    let mousePressed = false;
    // 是否移动
    let mouseMove = false;
    // 记录画图原点
    const startPoint = {x: 0, y: 0};


    // 图形 ID
    let lineId = 0;


    mySvg.addEventListener("mousedown", (e) => {
        mousePressed = true;
        mouseMove = false;

        startPoint.x = e.offsetX;
        startPoint.y = e.offsetY;
    });

    mySvg.addEventListener("mouseup", (e) => {
        const obj = e.target;

        if (mousePressed) {
            if (mouseMove) {
                // 按下且移动
                drawingObj.enableEdit();
            } else {
                // 只点击
                if (obj === mySvg && editingObj) {
                    // 清空编辑状态
                    editingObj.disableEdit();
                }
            }

        }
        mousePressed = false;
        lineId++;
        drawingObj = null;
    });

    mySvg.addEventListener("mousemove", (e) => {
        if (mousePressed) {
            mouseMove = true;
            // 拖且动
            if (editingObj) {
                editingObj.disableEdit();
                editingObj = false;
            }

            if (!drawingObj) {
                drawingObj = new SgLine({id: lineId, x: startPoint.x, y: startPoint.y});
                mySvg.appendChild(drawingObj.obj);
            }
            drawingObj.moveTo('', e.offsetX, e.offsetY)
        }
    });

</script>
</body>
</html>